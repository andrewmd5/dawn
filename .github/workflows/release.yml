name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: macos-arm64
            artifact: dawn-macos-arm64
          - os: macos-15-intel
            target: macos-x64
            artifact: dawn-macos-x64
          - os: ubuntu-latest
            target: linux-x64
            artifact: dawn-linux-x64
          - os: ubuntu-24.04-arm
            target: linux-arm64
            artifact: dawn-linux-arm64
          - os: windows-latest
            target: windows-x64
            artifact: dawn-windows-x64
            arch: x64
          - os: windows-11-arm
            target: windows-arm64
            artifact: dawn-windows-arm64
            arch: ARM64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo rm -f /var/lib/man-db/auto-update
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev

      - name: Build (Unix)
        if: "!startsWith(matrix.os, 'windows')"
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DDAWN_VERSION="$VERSION"
          cmake --build build -j
          strip build/dawn

      - name: Build (Windows)
        if: startsWith(matrix.os, 'windows')
        run: |
          $VERSION = "${{ github.ref_name }}" -replace '^v', ''
          cmake -S . -B build -A ${{ matrix.arch }} -DDAWN_VERSION="$VERSION"
          cmake --build build --config Release

      - name: Package (Unix)
        if: "!startsWith(matrix.os, 'windows')"
        run: |
          mkdir -p dist
          cp build/dawn dist/dawn
          cd dist && tar -czvf ${{ matrix.artifact }}.tar.gz dawn

      - name: Package (Windows)
        if: startsWith(matrix.os, 'windows')
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item build/Release/dawn.exe dist/dawn.exe
          Compress-Archive -Path dist/dawn.exe -DestinationPath dist/${{ matrix.artifact }}.zip

      - name: Upload artifact (Unix)
        if: "!startsWith(matrix.os, 'windows')"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}.tar.gz

      - name: Upload artifact (Windows)
        if: startsWith(matrix.os, 'windows')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        run: |
          gh release create ${{ github.ref_name }} \
            --generate-notes \
            artifacts/**/*.tar.gz \
            artifacts/**/*.zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dawn-*
          path: artifacts

      - name: Update Homebrew formula
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "Version: $VERSION"

          MACOS_ARM64_SHA=$(sha256sum artifacts/dawn-macos-arm64/dawn-macos-arm64.tar.gz | cut -d' ' -f1)
          MACOS_X64_SHA=$(sha256sum artifacts/dawn-macos-x64/dawn-macos-x64.tar.gz | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(sha256sum artifacts/dawn-linux-arm64/dawn-linux-arm64.tar.gz | cut -d' ' -f1)
          LINUX_X64_SHA=$(sha256sum artifacts/dawn-linux-x64/dawn-linux-x64.tar.gz | cut -d' ' -f1)

          MACOS_ARM64_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/dawn-macos-arm64.tar.gz"
          MACOS_X64_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/dawn-macos-x64.tar.gz"
          LINUX_ARM64_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/dawn-linux-arm64.tar.gz"
          LINUX_X64_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/dawn-linux-x64.tar.gz"

          echo "macOS ARM64 SHA: $MACOS_ARM64_SHA"
          echo "macOS x64 SHA: $MACOS_X64_SHA"
          echo "Linux ARM64 SHA: $LINUX_ARM64_SHA"
          echo "Linux x64 SHA: $LINUX_X64_SHA"

          # Clone homebrew tap and update formula
          git clone https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/andrewmd5/homebrew-tap.git tap

          cat > tap/Formula/dawn.rb << EOF
          class Dawn < Formula
            desc "Distraction-free terminal writing environment with live markdown rendering"
            homepage "https://github.com/${{ github.repository }}"
            version "$VERSION"
            license "MIT"

            on_macos do
              on_arm do
                url "$MACOS_ARM64_URL"
                sha256 "$MACOS_ARM64_SHA"
              end
              on_intel do
                url "$MACOS_X64_URL"
                sha256 "$MACOS_X64_SHA"
              end
            end

            on_linux do
              on_arm do
                url "$LINUX_ARM64_URL"
                sha256 "$LINUX_ARM64_SHA"
              end
              on_intel do
                url "$LINUX_X64_URL"
                sha256 "$LINUX_X64_SHA"
              end
            end

            def install
              bin.install "dawn"
            end

            test do
              assert_match "dawn", shell_output("#{bin}/dawn -h")
            end
          end
          EOF

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/dawn.rb
          git commit -m "dawn $VERSION"
          git push
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        continue-on-error: true
